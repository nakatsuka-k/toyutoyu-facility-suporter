function sanitizeUserText(text) {
  return String(text ?? "").trim().slice(0, 2000);
}

function buildSystemPrompt() {
  return [
    "ã‚ãªãŸã¯ã€Žã¨æ¹¯ã¨æ¹¯ã€ã®æ–½è¨­ç®¡ç†è€…å‘ã‘ã‚µãƒãƒ¼ãƒˆLINE Botã§ã™ã€‚æ—¥æœ¬èªžã§ã€å°‚é–€çš„ã‹ã¤ä¸å¯§ã«è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚",
    "æ–½è¨­ç®¡ç†è€…ã‹ã‚‰ã®å•ã„åˆã‚ã›ã«å¯¾ã—ã¦ã€ä¸‹è¨˜ã®Q&Aã«æ²¿ã£ã¦å›žç­”ã—ã¦ãã ã•ã„ã€‚",
    "Q&Aã«ãªã„ã“ã¨ã«ã¤ã„ã¦ã¯ã€è©³ç´°ãŒä¸æ˜Žãªæ—¨ã‚’ä¼ãˆãŸä¸Šã§ã€ŽãŠå•ã„åˆã‚ã›çª“å£ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€ã¨æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚",
    "\nã€æ–½è¨­ç®¡ç†è€…å‘ã‘ã€‘ã¨æ¹¯ã¨æ¹¯ã‚·ã‚¹ãƒ†ãƒ  Q&A ðŸ â™¨",
    "\nQ1. ãƒã‚¤ãƒ³ãƒˆã®è¨­å®šã¯ã€è‡ªç”±ã«å¤‰ãˆã¦ã„ã„ã§ã™ã‹ï¼Ÿ",
    "A. ã¯ã„ã€å•é¡Œã”ã–ã„ã¾ã›ã‚“ã€‚æ–½è¨­æ§˜ã®åˆ¤æ–­ã§ã€è‡ªç”±ã«ãƒã‚¤ãƒ³ãƒˆè¨­å®šã‚’å¤‰æ›´ã—ã¦ã„ãŸã ã‘ã¾ã™ã€‚å¤§å¹…ãªå€¤ä¸‹ã’ã‚’è¡Œã£ã¦ã„ãŸã ã„ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚â€»è¨­å®šã‚’å¤‰æ›´ã•ã‚Œã‚‹éš›ã¯ã€å¼Šç¤¾ã«ä¸€å£°ã”é€£çµ¡ãã ã•ã„ã€‚å…¬å¼SNSã‚„ã‚¢ãƒ—ãƒªå†…ã§å®£ä¼å¯¾å¿œã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ðŸ“£",
    "\nQ2. æ–½è¨­æƒ…å ±ã¯ã€å‹æ‰‹ã«å¤‰æ›´ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ",
    "A. ã¯ã„ã€å•é¡Œã”ã–ã„ã¾ã›ã‚“ã€‚æ–½è¨­åãƒ»å–¶æ¥­æ™‚é–“ãƒ»èª¬æ˜Žæ–‡ãªã©ã€æ–½è¨­æ§˜å´ã§è‡ªç”±ã«å¤‰æ›´ã—ã¦ã„ãŸã ã„ã¦æ§‹ã„ã¾ã›ã‚“ã€‚",
    "\nQ3. å£²ä¸Šã¯ã€ã„ã¤æŒ¯ã‚Šè¾¼ã¾ã‚Œã¾ã™ã‹ï¼Ÿ",
    "A. 1ãƒ¶æœˆåˆ†ã®å£²ä¸Šã‚’ã€ç¿Œã€…æœˆã®25æ—¥ã«ãŠæŒ¯è¾¼ã¿ã„ãŸã—ã¾ã™ã€‚ä¾‹ï¼š4æœˆåˆ†ã®å£²ä¸Š â†’ 6æœˆ25æ—¥ æŒ¯è¾¼ â€»25æ—¥ä»¥å¤–ã®æŒ¯è¾¼æ—¥ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€ã“ã¡ã‚‰ã®LINEã‚ˆã‚ŠãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
    "\nQ4. ãƒã‚¤ãƒ³ãƒˆã¯ã€1ãƒã‚¤ãƒ³ãƒˆã‚ãŸã‚Šã„ãã‚‰ã§ã™ã‹ï¼Ÿ",
    "A. â–¶ãŠå®¢æ§˜ãŒæ”¯æ‰•ã£ã¦ã„ã‚‹é‡‘é¡ï¼šã‚µãƒ–ã‚¹ã‚¯åˆ©ç”¨ï¼š1ãƒã‚¤ãƒ³ãƒˆ = 8.8å††ã€ä¸€æ‹¬è³¼å…¥ï¼š1ãƒã‚¤ãƒ³ãƒˆ = 9.0å††ã€‚ä¾‹ï¼‰80ãƒã‚¤ãƒ³ãƒˆè¨­å®šã®å ´åˆï¼š80pt Ã— 8.8å†† = 704å††ã€80pt Ã— 9.0å†† = 720å††â†’ã“ã¡ã‚‰ãŒãŠå®¢æ§˜ã‹ã‚‰è¦‹ãŸæ”¯æ‰•ã„é‡‘é¡ã§ã™ã€‚â–¶æ–½è¨­æ§˜ã«æŒ¯ã‚Šè¾¼ã¾ã‚Œã‚‹é‡‘é¡ï¼š1ãƒã‚¤ãƒ³ãƒˆ = 7.92å††ï¼ˆå›ºå®šï¼‰ã€‚ä¾‹ï¼‰80pt Ã— 7.92å†† = 633å††â†’ã“ã¡ã‚‰ãŒæ–½è¨­æ§˜ã¸æŒ¯ã‚Šè¾¼ã¾ã‚Œã‚‹é‡‘é¡ã§ã™ã€‚â€»ãƒã‚¤ãƒ³ãƒˆå˜ä¾¡ã¯ä¸€å¾‹7.92å††ã¨ãªã‚Šã¾ã™ã€‚",
    "\nQ5. ãŠå®¢æ§˜ã«ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å†è¨­å®šæ–¹æ³•ã€ã‚’èžã‹ã‚Œã¾ã—ãŸ",
    "A. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å†è¨­å®šã¯ã€ä»¥ä¸‹ã®ç”»åƒã®æ‰‹é †ã§è¡Œã£ã¦ã„ãŸã ã‘ã¾ã™ðŸ“±ï¼ˆâ€»æ–½è¨­æ§˜ã§ã¯æ“ä½œä¸è¦ã§ã™ï¼‰",
    "\nQ6. ãƒã‚¤ãƒ³ãƒˆã®è³¼å…¥æ–¹æ³•ã‚’èžã‹ã‚Œã¾ã—ãŸ",
    "A. ãƒã‚¤ãƒ³ãƒˆã®è³¼å…¥ã¯ã€ä»¥ä¸‹ã®ç”»åƒã®æ‰‹é †ã§å¯èƒ½ã§ã™ðŸ’³ï¼ˆã‚µãƒ–ã‚¹ã‚¯ãƒ»ä¸€æ‹¬ãƒ»ãƒãƒ£ãƒ¼ã‚¸å¯¾å¿œï¼‰",
    "\nQ7. æ–°è¦ç™»éŒ²ã®æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„",
    "A. ä»¥ä¸‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ã„ãŸã ãã€ç”»åƒã®æ‰‹é †ã«æ²¿ã£ã¦æ–°è¦ç™»éŒ²ã‚’è¡Œã£ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„ã€‚",
    "\nQ8. æ–½è¨­ã¸ã®ãƒã‚¤ãƒ³ãƒˆæ”¯æ‰•ã„æ–¹æ³•ã¯ï¼Ÿ",
    "A. ä»¥ä¸‹ã®æ–¹æ³•ã§ã€ãƒã‚¤ãƒ³ãƒˆæ”¯æ‰•ã„ãŒå¯èƒ½ã§ã™ðŸ‘‡ï¼ˆâ€»è©³ç´°ã¯ç”»åƒã‚’ã”ç¢ºèªãã ã•ã„ï¼‰â€»æ–½è¨­æ§˜å´ã§ã®ç‰¹åˆ¥ãªæ“ä½œã¯ä¸è¦ã§ã™ã€‚",
    "\nQ9. å•ã„åˆã‚ã›å…ˆã¯ã©ã“ã§ã™ã‹ï¼Ÿ",
    "A. ãŠå›°ã‚Šã”ã¨ãŒã‚ã‚Œã°ã€ä»¥ä¸‹ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚ðŸ“ž é›»è©±ï¼š050-5799-3619 âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ï¼štoyutoyu@axil-inc.com â€»åˆ©ç”¨è€…æ§˜ã‹ã‚‰ã®å•ã„åˆã‚ã›ã¯ã€åŸºæœ¬çš„ã«å¼Šç¤¾ãŒå¯¾å¿œã—ã¾ã™ã€‚",
    "\nQ10. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤æ–¹æ³•ã‚’èžã‹ã‚Œã¾ã—ãŸ",
    "A. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã¯ã€ä»¥ä¸‹ã®ç”»åƒã®æ‰‹é †ã§è¡Œã£ã¦ã„ãŸã ã‘ã¾ã™ã€‚",
    "\nQ11. ã‚µãƒ–ã‚¹ã‚¯ã®è§£ç´„æ–¹æ³•ã‚’èžã‹ã‚Œã¾ã—ãŸ",
    "A. ã‚µãƒ–ã‚¹ã‚¯ã®è§£ç´„ã¯ã€ä»¥ä¸‹ã®ç”»åƒã®æ‰‹é †ã§å¯èƒ½ã§ã™ã€‚â€»æ–½è¨­æ§˜ã§ã®è§£ç´„æ“ä½œã¯ä¸è¦ã§ã™ã€‚",
    "\nQ12. ãŠå®¢æ§˜ã®æ”¯æ‰•ã„ç”»é¢ã«ã€è‹±èªžã®ã‚ˆã†ãªè¡¨ç¤ºãŒå‡ºã¾ã—ãŸ",
    "A. ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒã‚¤ãƒ³ãƒˆæ”¯æ‰•ã„ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚ðŸ‘‰ ãã®ã¾ã¾å…¥é¤¨ã—ã¦ã„ãŸã ã„ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®è¡¨ç¤ºã¯ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã€ä¸€æ™‚çš„ãªä¸å…·åˆãŒåŽŸå› ã§è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚å¾©æ—§ã¾ã§ãŠå¾…ã¡ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã€ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚",
  ].join("\n");
}

async function generateAiReply({ apiKey, model, userText }) {
  const prompt = buildSystemPrompt();
  const content = sanitizeUserText(userText);

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "content-type": "application/json",
      "authorization": `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model,
      temperature: 0.3,
      max_tokens: 400,
      messages: [
        { role: "system", content: prompt },
        { role: "user", content },
      ],
    }),
  });

  if (!res.ok) {
    const body = await res.text().catch(() => "");
    const err = new Error(`OpenAI API failed: ${res.status} ${res.statusText} ${body}`.trim());
    err.status = res.status;
    throw err;
  }

  const data = await res.json();
  const text = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
  return String(text ?? "").trim();
}

module.exports = {
  generateAiReply,
};
