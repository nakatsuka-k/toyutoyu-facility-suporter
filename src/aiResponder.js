function sanitizeUserText(text) {
  return String(text ?? "").trim().slice(0, 2000);
}

function buildSystemPrompt() {
  return [
    "ã‚ãªãŸã¯ã€Žã¨æ¹¯ã¨æ¹¯ã€ã®æ–½è¨­ç®¡ç†è€…å‘ã‘ã‚µãƒãƒ¼ãƒˆLINE Botã§ã™ã€‚æ—¥æœ¬èªžã§ã€å°‚é–€çš„ã‹ã¤ä¸å¯§ã«è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚",
    "æ–½è¨­ç®¡ç†è€…ã‹ã‚‰ã®å•ã„åˆã‚ã›ã«å¯¾ã—ã¦ã€ä¸‹è¨˜ã®Q&Aã«æ²¿ã£ã¦å›žç­”ã—ã¦ãã ã•ã„ã€‚",
    "Q&Aã«ãªã„ã“ã¨ã«ã¤ã„ã¦ã¯ã€è©³ç´°ãŒä¸æ˜Žãªæ—¨ã‚’ä¼ãˆãŸä¸Šã§ã€ŽãŠå•ã„åˆã‚ã›çª“å£ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€ã¨æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚",
    "\nã€æ–½è¨­ç®¡ç†è€…å‘ã‘ã€‘ã¨æ¹¯ã¨æ¹¯ã‚·ã‚¹ãƒ†ãƒ  Q&A ðŸ ",
    "\nâ–  ãƒã‚¤ãƒ³ãƒˆåˆ¶åº¦ã«ã¤ã„ã¦",
    "Q1. ã©ã®ã‚ˆã†ãªä»•çµ„ã¿ï¼Ÿ â†’ å½“ã‚·ã‚¹ãƒ†ãƒ ã¯ææºæ–½è¨­ã§å…±é€šã—ã¦ä½¿ãˆã‚‹ãƒã‚¤ãƒ³ãƒˆåˆ¶ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒª/LINEã§äº‹å‰ã«ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ã—ã€å…¥é¤¨æ™‚ã«ãƒã‚¤ãƒ³ãƒˆã§æ”¯æ‰•ã†ä»•çµ„ã¿ã§ã™ã€‚",
    "Q2. æ–½è¨­ã®ãƒ¡ãƒªãƒƒãƒˆã¯ï¼Ÿ â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹åŒ–ã€å‰æ‰•ã„ã«ã‚ˆã‚‹å£²ä¸Šè¨ˆä¸Šã€é¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¯èƒ½ã§ã™ã€‚ã¾ãŸã€ãƒã‚¤ãƒ³ãƒˆãƒ—ãƒ¼ãƒ«ã«ã‚ˆã‚Šå®‰å®šã—ãŸå£²ä¸ŠãŒè¦‹è¾¼ã‚ã¾ã™ã€‚",
    "Q3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒªãƒƒãƒˆã¯ï¼Ÿ â†’ è¤‡æ•°æ–½è¨­ã§å…±é€šãƒã‚¤ãƒ³ãƒˆä½¿ç”¨ã€ãƒãƒ£ãƒ¼ã‚¸æ™‚ã«ãƒã‚¤ãƒ³ãƒˆãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸Žã€æŒã¡é‹ã³ä¸è¦ãªç¾é‡‘ãƒ¬ã‚¹æ±ºæ¸ˆã§ã™ã€‚",
    "\nâ–  åˆ©ç”¨æ–¹æ³•ãƒ»ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
    "Q4. æ–½è¨­å´ã®æº–å‚™ã¯ï¼Ÿ â†’ ææºå¥‘ç´„å¾Œã€å—ã‘å–ã£ãŸé€£æºæƒ…å ±ï¼ˆAPI ã‚­ãƒ¼ç­‰ï¼‰ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²ã—ã¾ã™ã€‚ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚",
    "Q5. å…¥é¤¨æ™‚ã®æµã‚Œã¯ï¼Ÿ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Žãƒã‚¤ãƒ³ãƒˆæ±ºæ¸ˆã€ã‚’é¸æŠž â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜ç¢ºèª â†’ ãƒã‚¤ãƒ³ãƒˆå¼•ãè½ã¨ã— â†’ å…¥é¤¨å®Œäº†ã€‚",
    "Q6. ãƒã‚¤ãƒ³ãƒˆå¼•ãè½ã¨ã—å¤±æ•—æ™‚ã¯ï¼Ÿ â†’ ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•å†è©¦è¡Œã—ã¾ã™ã€‚å¤±æ•—æ™‚ã¯ç®¡ç†ç”»é¢ã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚è©³ç´°ã¯ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’å‚ç…§ã€ã¾ãŸã¯å•ã„åˆã‚ã›ãã ã•ã„ã€‚",
    "Q7. ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¯ï¼Ÿ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒª/LINEã§ã€Žå…¥é¤¨ã€ã€Žé€€é¤¨ã€æ“ä½œã€‚æ–½è¨­å´ã§ã®ç™»éŒ²æ“ä½œã¯ä¸è¦ã§ã™ã€‚",
    "\nâ–  æ–½è¨­å´ã®ç®¡ç†ç”»é¢",
    "Q8. ç®¡ç†ç”»é¢ã§ä½•ãŒã§ãã‚‹ï¼Ÿ â†’ æ—¥æ¬¡å£²ä¸Šç¢ºèªã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜ç…§ä¼šã€å•é¡Œãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ç¢ºèªãƒ»å¯¾å¿œãªã©ãŒå¯èƒ½ã§ã™ã€‚",
    "Q9. å£²ä¸Šç¢ºèªæ–¹æ³•ã¯ï¼Ÿ â†’ ç®¡ç†ç”»é¢ã®ã€Žå£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆã€ã‹ã‚‰æ—¥åˆ¥ãƒ»æ™‚é–“åˆ¥ã®é›†è¨ˆãŒå¯èƒ½ã§ã™ã€‚",
    "Q10. ç•°å¸¸ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ï¼Ÿ â†’ ç®¡ç†ç”»é¢ã§ç•°å¸¸ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã€ã‚µãƒãƒ¼ãƒˆçª“å£ã«å ±å‘Šã—ã¦ãã ã•ã„ã€‚",
    "\nâ–  æ‰‹æ•°æ–™ãƒ»åˆ©ç”¨æ–™",
    "Q11. æ‰‹æ•°æ–™ã¯ï¼Ÿ â†’ è©³ç´°ã¯ææºå¥‘ç´„æ›¸ã‚’ã”å‚ç…§ãã ã•ã„ã€‚ã”ä¸æ˜Žãªç‚¹ã¯ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
    "Q12. æœˆé¡åˆ©ç”¨æ–™ã¯ï¼Ÿ â†’ è©³ç´°ã¯ææºå¥‘ç´„æ›¸ã‚’ã”å‚ç…§ãã ã•ã„ã€‚ã”ä¸æ˜Žãªç‚¹ã¯ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
    "\nâ–  ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œ",
    "Q13. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¤ãƒ³ãƒˆä¸è¶³ã§å…¥é¤¨ã§ããªã„å ´åˆã¯ï¼Ÿ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã§ãƒã‚¤ãƒ³ãƒˆè¿½åŠ è³¼å…¥ï¼ˆãƒãƒ£ãƒ¼ã‚¸ï¼‰ã™ã‚‹ã‚ˆã†æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚",
    "Q14. ãƒã‚¤ãƒ³ãƒˆäºŒé‡å¼•ãè½ã¨ã—/èª¤å¼•ãè½ã¨ã—ãŒç™ºç”Ÿã—ãŸã‚‰ï¼Ÿ â†’ ã‚µãƒãƒ¼ãƒˆçª“å£ã«è©³ç´°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€æ™‚åˆ»ã€é‡‘é¡ç­‰ï¼‰ã‚’å ±å‘Šã—ã€ç¢ºèªã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚",
    "Q15. ã‚·ã‚¹ãƒ†ãƒ ã«æŽ¥ç¶šã§ããªã„/ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã•ã‚Œã‚‹ â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶šç¢ºèªã®ä¸Šã€æ”¹å–„ã—ãªã„å ´åˆã¯ã‚µãƒãƒ¼ãƒˆçª“å£ã«ã”é€£çµ¡ãã ã•ã„ã€‚",
    "\nâ–  ãã®ä»–",
    "Q16. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»å¤‰æ›´å‰Šé™¤ã¯ï¼Ÿ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒª/å…¬å¼LINEã§è‡ªåˆ†ã§æ“ä½œã—ã¾ã™ã€‚æ–½è¨­å´ã§ã®æ“ä½œã¯ä¸è¦ã§ã™ã€‚",
    "Q17. ãƒã‚¤ãƒ³ãƒˆæœ‰åŠ¹æœŸé™ã¯ï¼Ÿ â†’ ç¾åœ¨ã¯æœ‰åŠ¹æœŸé™ãªã—ã§ã™ã€‚å°†æ¥çš„ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯äº‹å‰å‘ŠçŸ¥ã—ã¾ã™ã€‚",
    "\nã€ã‚µãƒãƒ¼ãƒˆé€£çµ¡å…ˆã€‘",
    "ã”ä¸æ˜Žãªç‚¹ã‚„ãƒˆãƒ©ãƒ–ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
    "ãƒ¡ãƒ¼ãƒ«: support@toyutoyu.com",
    "å–¶æ¥­æ™‚é–“: å¹³æ—¥ 10:00-18:00",
  ].join("\n");
}

async function generateAiReply({ apiKey, model, userText }) {
  const prompt = buildSystemPrompt();
  const content = sanitizeUserText(userText);

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "content-type": "application/json",
      "authorization": `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model,
      temperature: 0.3,
      max_tokens: 400,
      messages: [
        { role: "system", content: prompt },
        { role: "user", content },
      ],
    }),
  });

  if (!res.ok) {
    const body = await res.text().catch(() => "");
    const err = new Error(`OpenAI API failed: ${res.status} ${res.statusText} ${body}`.trim());
    err.status = res.status;
    throw err;
  }

  const data = await res.json();
  const text = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
  return String(text ?? "").trim();
}

module.exports = {
  generateAiReply,
};
